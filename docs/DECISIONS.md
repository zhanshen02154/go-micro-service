# 微服务架构演进实践决策记录

## 决策记录：商品服务连接Consul加载K/V

### 日期
2025年10月23日

### 状态
已采纳

### 背景
商品服务的配置迁移到Consul的K/V后还要区分测试环境和生产环境，连接Consul成为启动项目最大的障碍。

### 初步方案
构建Docker镜像时复制config目录下的配置文件，在入口函数加载Consul配置。

#### 优点：
- 通过持久化的配置文件加载，减少代码层面的改动。

#### 缺点：
- 读取Consul配置后需要把K/V的信息解析到配置的结构体，即从多个源合并配置，合并操作需要手动实现。

### 最终方案
构建Docker镜像时结合构建参数将Consul基本配置注入到容器里的环境变量，通过环境变量获取Consul的地址和Token。

#### 采纳理由
- 构建镜像时通过参数通过注入到系统环境变量读取Consul连接信息连接获取K/V，彻底脱离配置文件。

#### 后果
- 构建镜像未携带参数或参数值错误将导致配置读取失败终止运行。

---

## 决策记录：运行环境服务器配置 
### 日期
2025年10月22日
### 状态
已采纳
### 背景
Apisix、Apisix Ingress Controller及K8S底层组件、Docker需要消耗部分内存，2核 CPU和2GB内存可能不足以应对额外部署的两个服务。
### 考虑方案
### 方案A：细化服务器资源分配，降低2个服务的CPU和内存使用量。
#### 优点：
- 无需升级服务器，不会导致成本上升。
#### 缺点：
- Pod资源极度紧张，底层组件和服务可能崩溃。
- 压测时Golang服务无法发挥多核CPU的优势，代码层面优化空间极为有限，压测已无意义。
### 方案B：升级2台运行环境服务器配置为4核8GB
#### 优点：
- Pod资源明显增多，可以做压测，底层组件崩溃概率降低。
#### 缺点：
- 服务器耗费的成本上升。
### 决策结果
采用方案B：升级2台运行环境服务器配置为4核8GB
### 理由：
- 虽然成本上升，但可以保证服务器资源不紧张，为后续的压测做好准备。
- 留出足够的空间给Apisix和底层组件。
### 后果：
- 复杂调用链路仍可能出现资源紧张问题

---

## 决策记录：Apisix内置ETCD问题
### 日期
2025年10月22日
### 状态
已采纳
### 背景
用helm安装Apisix内置一个ETCD组件，该组件随Apisix一同部署到K8S集群，安装后ETCD一直卡在申请PVC，其他服务也无法启动。
### 考虑方案
### 方案A：使用NFS挂载，深入研究PV/PVC再做配置
#### 优点：
- 使用内置ETCD，无需编写Values配置文件。
#### 缺点：
- ETCD伴随Apisix部署在K8S集群增加了运行环境的压力，不符合生产环境要求。
- NFS挂载操作步骤较多。

### 方案B：使用外部ETCD
#### 优点：
- ETCD独立部署，无需考虑PV/PVC的问题。
#### 缺点：
- 基础设施服务器压力增加
### 决策结果
使用外部ETCD。
### 理由：
- 独立部署ETCD符合生产环境要求，后续若时间充足可考虑复用已有资源将服务注册/发现从Consul迁移到ETCD。
- 留出足够的空间给Apisix和底层组件。
### 实施方案：
1. 在基础设施服务器独立部署ETCD，Apisix的values.yaml文件配置关闭内置etcd连接外部ETCD，为网关、底层组件和2个服务腾出服务器资源。
2. 服务器仅2台且均为4核CPU和8GB内存，资源极为紧张，故需要对Apisix及其各项组件和服务进行精细化控制，资源分配如下：

| 组件                        | CPU requests | CPU limits | Memory requests | Memory limits | 副本数          |
|---------------------------|--------------|------------|-----------------|---------------|--------------|
| Apisix                    | 500m         | 1000m      | 512Mi           | 800Mi         | 2            |
| Apisix Gateway            | 500m         | 1000m      | 512Mi           | 1Gi           | 2            |
| Apisix Ingress Controller | 200m         | 500m       | 128Mi           | 256Mi         | 2            |
| 订单服务/商品服务                 | 500m         | 1000m      | 256Mi           | 512Mi         | 2（每个服务各2个副本） | 

累计共分配3.5核 CPU和约3.03G内存，可供底层组件稳定运行，各组件可正常运行，防止单节点资源耗尽。

### 后果：
- 基础设施服务器压力增加，目前基础设施服务器安装了Jenkins、MySQL、Harbor、Redis、Docker、Consul但配置仅为2核 CPU和4GB内存。
- 压测过程中可能需要暂时关闭jenkins。
- 单节点ETCD发生故障会造成Apisix崩溃。